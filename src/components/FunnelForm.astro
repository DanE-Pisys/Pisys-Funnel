---
/**
 * FunnelForm.astro
 * Compact form optimised for single-screen conversion panel.
 * - Responsive field grid (Role + Phone side-by-side on desktop)
 * - Minimal spacing to fit 768px+ viewports without scroll
 * - Web3Forms honeypot included
 */
const accessKey = import.meta.env.PUBLIC_WEB3FORMS_KEY?.trim();
const missingKey = !accessKey;
---

<div class="funnel-form-card form-shell lg:max-h-full lg:overflow-y-auto">
  <p class="text-sm font-semibold text-[var(--color-primary)] mb-3">Confidential risk snapshot</p>

  <form id="audit-form" class="space-y-3" method="POST" action="https://api.web3forms.com/submit">
    <input type="hidden" name="access_key" value={accessKey} />
    <!-- Honeypot for spam prevention -->
    <input type="checkbox" name="botcheck" class="hidden" style="display:none;" tabindex="-1" autocomplete="off" />

    <!-- Name -->
    <div>
      <label class="label" for="name">Full name</label>
      <input
        class="input py-2.5"
        id="name"
        name="name"
        type="text"
        required
        autocomplete="name"
      />
    </div>

    <!-- Email -->
    <div>
      <label class="label" for="email">Work email</label>
      <input
        class="input py-2.5"
        id="email"
        name="email"
        type="email"
        required
        autocomplete="email"
      />
    </div>

    <!-- Company -->
    <div>
      <label class="label" for="company">Company</label>
      <input
        class="input py-2.5"
        id="company"
        name="company"
        type="text"
        required
        autocomplete="organization"
      />
    </div>

    <!-- Role + Phone (side-by-side on lg+) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
      <div>
        <label class="label" for="role">
          Role <span class="text-[var(--color-muted)] font-normal">(optional)</span>
        </label>
        <input
          class="input py-2.5"
          id="role"
          name="role"
          type="text"
          placeholder="e.g., IT Director"
        />
      </div>
      <div>
        <label class="label" for="phone">
          Phone <span class="text-[var(--color-muted)] font-normal">(optional)</span>
        </label>
        <input
          class="input py-2.5"
          id="phone"
          name="phone"
          type="tel"
          autocomplete="tel"
        />
      </div>
    </div>

    <!-- Top concern -->
    <div>
      <label class="label" for="focus">
        Top concern <span class="text-[var(--color-muted)] font-normal">(optional)</span>
      </label>
      <select id="focus" name="focus" class="input py-2.5 bg-white" aria-describedby="focus-help">
        <option value="">Select one</option>
        <option>Microsoft 365 security</option>
        <option>Ransomware & backups</option>
        <option>Incident response readiness</option>
        <option>Third-party/vendor risk</option>
        <option>General posture review</option>
      </select>
    </div>

    <!-- Context (auto-grow textarea) -->
    <div>
      <label class="label" for="notes">
        Context <span class="text-[var(--color-muted)] font-normal">(optional)</span>
      </label>
      <textarea
        class="input py-2.5 resize-none"
        id="notes"
        name="notes"
        rows="2"
        placeholder="Anything we should know?"
        data-autogrow
      ></textarea>
    </div>

    <!-- Submit -->
    <div class="pt-1">
      <button class="btn-primary w-full text-white" type="submit">
        Request my risk snapshot
      </button>
      <p id="focus-help" class="text-xs text-[var(--color-muted)] text-center mt-2">
        We'll email within 1 business day. Your details stay with us.
      </p>
    </div>

    <!-- Success/Error messages -->
    <p
      id="form-success"
      class="hidden text-sm font-semibold text-green-700 bg-green-50 border border-green-200 rounded-lg p-3"
      role="status"
      aria-live="polite"
    >
      Thanks! We'll email within one business day to schedule the scope call.
    </p>
    <p
      id="form-error"
      class="hidden text-sm font-semibold text-[var(--color-accent)] bg-red-50 border border-red-200 rounded-lg p-3"
      role="alert"
      aria-live="polite"
    >
      Something went wrong. Please try again or email us directly.
    </p>
    <button
      id="edit-resend"
      type="button"
      class="hidden text-sm font-semibold text-[var(--color-primary)] underline"
      aria-live="polite"
    >
      Edit & resend
    </button>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("audit-form") as HTMLFormElement | null;
    const success = document.getElementById("form-success");
    const error = document.getElementById("form-error");
    const submitBtn = form?.querySelector('button[type="submit"]') as HTMLButtonElement | null;
    const editBtn = document.getElementById("edit-resend");
    const textarea = document.querySelector('[data-autogrow]') as HTMLTextAreaElement | null;

    // Auto-grow textarea
    if (textarea) {
      const adjustHeight = () => {
        textarea.style.height = 'auto';
        const maxHeight = 120; // ~5 lines
        textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
      };
      textarea.addEventListener('input', adjustHeight);
    }

    if (!form || !submitBtn) return;

    // Check if access key is present (it will be empty string if not set)
    const accessKeyInput = form.querySelector('input[name="access_key"]') as HTMLInputElement | null;
    const hasKey = accessKeyInput?.value?.trim();

    if (!hasKey) {
      error?.classList.remove("hidden");
      if (error) error.textContent = "Form temporarily unavailable. Please try again shortly.";
      submitBtn.disabled = true;
      form.addEventListener("submit", (e) => e.preventDefault());
      return;
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      success?.classList.add("hidden");
      error?.classList.add("hidden");
      submitBtn.disabled = true;
      submitBtn.textContent = "Sending...";

      const data = new FormData(form);

      try {
        const response = await fetch(form.action, {
          method: "POST",
          body: data
        });
        const result = await response.json();
        if (result.success) {
          success?.classList.remove("hidden");
          submitBtn.textContent = "Request received";
          submitBtn.disabled = true;
          success?.focus();
          editBtn?.classList.remove("hidden");
        } else {
          error?.classList.remove("hidden");
          error?.focus();
          submitBtn.disabled = false;
          submitBtn.textContent = "Request my risk snapshot";
        }
      } catch (err) {
        error?.classList.remove("hidden");
        error?.focus();
        submitBtn.disabled = false;
        submitBtn.textContent = "Request my risk snapshot";
      }
    });

    editBtn?.addEventListener("click", () => {
      success?.classList.add("hidden");
      error?.classList.add("hidden");
      submitBtn.disabled = false;
      submitBtn.textContent = "Request my risk snapshot";
      editBtn.classList.add("hidden");
      form.querySelectorAll("input, select, textarea").forEach((el) => {
        (el as HTMLInputElement).removeAttribute("disabled");
      });
    });
  });
</script>
