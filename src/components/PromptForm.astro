---
const accessKey = import.meta.env.PUBLIC_WEB3FORMS_KEY?.trim();
const missingKey = !accessKey;
---
<section id="request" class="section bg-white">
  <div class="wrap grid gap-6 lg:grid-cols-[1.05fr_0.95fr] items-start">
    <div class="space-y-4">
      <p class="eyebrow">Prompt</p>
      <h2 class="section-heading">Request the free cyber risk audit</h2>
      <p class="text-[var(--color-text)] max-w-2xl">
        We’ll arrange a quick scope confirmation call within one business day and deliver a board-ready snapshot with prioritized actions. No obligation to proceed beyond the audit.
      </p>
      <ul class="list-disc pl-5 text-[var(--color-text)] space-y-1 text-sm">
        <li>Board snapshot with ranked risks.</li>
        <li>Top exposures and 30/60/90-day actions.</li>
        <li>Owners and next steps agreed on the scope call.</li>
      </ul>
      <div class="grid sm:grid-cols-2 gap-3 text-sm text-[var(--color-text)]">
        <div class="p-3 rounded-lg bg-subtle border border-[var(--color-border)]">
          <p class="font-semibold text-[var(--color-primary)]">Availability</p>
          <p class="text-[var(--color-muted)]">10 free audit slots remain this month.</p>
        </div>
        <div class="p-3 rounded-lg bg-subtle border border-[var(--color-border)]">
          <p class="font-semibold text-[var(--color-primary)]">Fit</p>
          <p class="text-[var(--color-muted)]">Designed for UK businesses with 5–250 staff.</p>
        </div>
      </div>
      <p class="text-sm text-[var(--color-muted)]">
        Remote-first delivery. Outputs aligned to ISO 27001, ISO 9001, and Cyber Essentials Plus practices.
      </p>
    </div>

      <div class="form-shell">
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm font-semibold text-[var(--color-primary)]">Confidential risk snapshot</p>
        </div>
      <form id="audit-form" class="space-y-5" method="POST" action="https://api.web3forms.com/submit">
        <input type="hidden" name="access_key" value={accessKey} />
        <!-- Honeypot for spam prevention -->
        <input type="checkbox" name="botcheck" class="hidden" style="display:none;" tabindex="-1" autocomplete="off" />
        <div>
          <label class="label" for="name">Full name</label>
          <input class="input" id="name" name="name" type="text" required autocomplete="name" />
        </div>
        <div>
          <label class="label" for="email">Work email</label>
          <input class="input" id="email" name="email" type="email" required autocomplete="email" />
        </div>
        <div>
          <label class="label" for="company">Company</label>
          <input class="input" id="company" name="company" type="text" autocomplete="organization" required />
        </div>
        <div>
          <label class="label" for="role">Role <span class="text-[var(--color-muted)] font-normal">(optional)</span></label>
          <input class="input" id="role" name="role" type="text" placeholder="e.g., Managing Director" />
        </div>
        <div>
          <label class="label" for="phone">Phone (optional)</label>
          <input class="input" id="phone" name="phone" type="tel" autocomplete="tel" />
        </div>
        <div>
          <label class="label" for="focus">Top concern right now <span class="text-[var(--color-muted)] font-normal">(optional)</span></label>
          <select id="focus" name="focus" class="input bg-white" aria-describedby="focus-help">
            <option value="">Select one (optional)</option>
            <option>Microsoft 365 security</option>
            <option>Ransomware & backups</option>
            <option>Incident response readiness</option>
            <option>Third-party/vendor risk</option>
            <option>General posture review</option>
          </select>
        </div>
        <div>
          <label class="label" for="notes">Context (optional)</label>
          <textarea class="input" id="notes" name="notes" rows="3" placeholder="Anything we should know before the call?"></textarea>
        </div>
        <p id="focus-help" class="text-xs text-[var(--color-muted)]">Pick the closest area or leave blank.</p>
        <div class="space-y-2">
          <button class="btn-primary w-full text-white" type="submit">Request my risk snapshot</button>
          <p class="text-xs text-[var(--color-muted)] text-center">We’ll email within 1 business day to arrange the scope confirmation call. Your details stay with us.</p>
        </div>
        <p id="form-success" class="hidden text-sm font-semibold text-green-700 bg-green-50 border border-green-200 rounded-lg p-3" role="status" aria-live="polite">
          Thanks, we’ve received your request. We’ll email within one business day to schedule the scope confirmation call.
        </p>
        <p id="form-error" class="hidden text-sm font-semibold text-[var(--color-accent)] bg-red-50 border border-red-200 rounded-lg p-3" role="alert" aria-live="polite">
          Something went wrong. Please try again or email us directly.
        </p>
        <button id="edit-resend" type="button" class="hidden text-sm font-semibold text-[var(--color-primary)] underline" aria-live="polite">Edit & resend</button>
      </form>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("audit-form") as HTMLFormElement | null;
    const success = document.getElementById("form-success");
    const error = document.getElementById("form-error");
    const submitBtn = form?.querySelector('button[type="submit"]') as HTMLButtonElement | null;
    const editBtn = document.getElementById("edit-resend");

    if (!form || !submitBtn) return;

    // Check if access key is present by reading it from the hidden input
    const accessKeyInput = form.querySelector('input[name="access_key"]') as HTMLInputElement | null;
    const hasKey = accessKeyInput?.value?.trim();

    if (!hasKey) {
      error?.classList.remove("hidden");
      if (error) error.textContent = "Form temporarily unavailable. Please try again shortly.";
      submitBtn.disabled = true;
      form.addEventListener("submit", (e) => e.preventDefault());
      return;
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      success?.classList.add("hidden");
      error?.classList.add("hidden");
      submitBtn.disabled = true;
      submitBtn.textContent = "Sending...";

      const data = new FormData(form);

      try {
        const response = await fetch(form.action, {
          method: "POST",
          body: data
        });
        const result = await response.json();
        if (result.success) {
          success?.classList.remove("hidden");
          submitBtn.textContent = "Request received";
          submitBtn.disabled = true;
          success?.focus();
          editBtn?.classList.remove("hidden");
        } else {
          error?.classList.remove("hidden");
          error?.focus();
          submitBtn.disabled = false;
          submitBtn.textContent = "Request my risk snapshot";
        }
      } catch (err) {
        error?.classList.remove("hidden");
        error?.focus();
        submitBtn.disabled = false;
        submitBtn.textContent = "Request my risk snapshot";
      }
    });

    editBtn?.addEventListener("click", () => {
      success?.classList.add("hidden");
      error?.classList.add("hidden");
      submitBtn.disabled = false;
      submitBtn.textContent = "Request my risk snapshot";
      editBtn.classList.add("hidden");
      form.querySelectorAll("input, select, textarea").forEach((el) => {
        (el as HTMLInputElement).removeAttribute("disabled");
      });
    });
  });
</script>
